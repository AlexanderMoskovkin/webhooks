{"version":3,"sources":["app.js"],"names":[],"mappings":"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","file":"app.js","sourcesContent":["import * as webhooksHandler from './webhooks-handler.js';\r\nimport EventEmitter from './event-emitter.js';\r\n\r\nvar MESSAGE_TYPES = {\r\n    PULL_REQUEST: 'pullRequest',\r\n    STATUS: 'status',\r\n    DEFAULT: 'default'\r\n};\r\n\r\nclass WebhooksListener {\r\n    constructor() {\r\n        this.eventEmitter = new EventEmitter();\r\n    }\r\n\r\n    on(evt, listener) {\r\n        return this.eventEmitter.on(evt, listener);\r\n    }\r\n\r\n    off(evt, listener) {\r\n        return this.eventEmitter.off(evt, listener);\r\n    }\r\n\r\n    addMessage(header, body) {\r\n        var event = '';\r\n\r\n        switch (header) {\r\n            case 'pull_request':\r\n                event = MESSAGE_TYPES.PULL_REQUEST;\r\n                break;\r\n\r\n            case 'status':\r\n                event = MESSAGE_TYPES.STATUS;\r\n                break;\r\n\r\n            default:\r\n                event = MESSAGE_TYPES.DEFAULT;\r\n                break;\r\n        }\r\n\r\n        this.eventEmitter.emit(event, {\r\n            body: body\r\n        });\r\n    }\r\n}\r\n\r\nfunction getPullRequest() {\r\n    return {\r\n        \"action\": \"opened\",\r\n        \"number\": 47,\r\n        \"pull_request\": {\r\n            \"id\": 37809578,\r\n            \"number\": 47,\r\n            \"head\": {\r\n                \"label\": \"AlexanderMoskovkin-test1:master\",\r\n                \"sha\": \"609566bb74f0c094dd5c01437d70e5a762c58757\"\r\n            },\r\n            \"base\": {\r\n                \"sha\": \"9c88ece2cb93a99e4082bd1c468d0e11041b3f6d\"\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction getStatus(state) {\r\n    return {\r\n        \"id\": 242623552,\r\n        \"sha\": \"5d4290f1065b18b14e38f2f26d416c7d4571b6c8\",\r\n        \"name\": \"AlexanderMoskovkin/testcafe-phoenix\",\r\n        \"target_url\": \"https://magnum.travis-ci.com/AlexanderMoskovkin/testcafe-phoenix/builds/12810986\",\r\n        \"state\": state,\r\n        \"context\": \"continuous-integration/travis-ci/push\"\r\n    };\r\n}\r\n\r\nfunction getPendingStatus() {\r\n    return getStatus('pending');\r\n}\r\n\r\nfunction getSuccessStatus() {\r\n    return getStatus('success');\r\n}\r\n\r\nfunction getFailedStatus() {\r\n    return getStatus('failure');\r\n}\r\n\r\nvar webhooksListener = new WebhooksListener();\r\n\r\nwebhooksListener.on(MESSAGE_TYPES.PULL_REQUEST, function (e) {\r\n    var prBody = e.body;\r\n    var baseCommitSha = prBody.pull_request.base.sha;\r\n    var prHeadLabel = prBody.pull_request.head.label;\r\n    var prId = prBody.pull_request.id;\r\n    var prNumber = prBody.number;\r\n\r\n    webhooksHandler.onPullRequest(baseCommitSha, prHeadLabel, prId, prNumber)\r\n        .then(function (prCtx) {\r\n            function onStatusMessage(e) {\r\n                var statusBody = e.body;\r\n\r\n                if (!/continuous-integration\\/travis-ci\\//.test(context))\r\n                    return;\r\n\r\n                if (statusBody.sha !== testedCommitSha)\r\n                    return;\r\n\r\n                if (statusBody.state === 'pending')\r\n                    return;\r\n\r\n                webhooksListener.off(MESSAGE_TYPES.STATUS, onStatusMessage);\r\n\r\n                webhooksHandler.onTestsFinished(prCtx, statusBody.state, statusBody.target_url);\r\n            }\r\n\r\n            webhooksListener.on(MESSAGE_TYPES.STATUS, onStatusMessage);\r\n        });\r\n});\r\n\r\n//webhooksListener.addMessage('pull_request', getPullRequest());\r\n/*setTimeout(function () {\r\n    webhooksListener.addMessage('status', getPendingStatus());\r\n}, 1000);*/\r\nsetTimeout(function () {\r\n    var status = getFailedStatus();\r\n\r\n    webhooksHandler.onTestsFinished({\r\n        prNumber: 47,\r\n        testBranchName: 'rp-37809578'\r\n    }, status.state, status.target_url);\r\n}, 2000);\r\n"],"sourceRoot":"../src"}